{% extends "base.html" %}

{% block title %}Lookalike - 문의 게시판{% endblock %}

{% block content %}
<div class="inquiry-page">
    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1"><i class="far fa-comment-dots me-2 text-primary"></i>문의 게시판</h4>
            <p class="text-muted mb-0" style="font-size: 0.85rem;">궁금한 점이나 불편사항을 문의해주세요.</p>
        </div>
        <button class="btn btn-dark btn-sm rounded-pill px-3 shadow-sm" onclick="showWriteForm()" id="writeInquiryBtn">
            <i class="fas fa-pen me-1"></i> 문의 작성
        </button>
    </div>

    <!-- 로그인 필요 안내 -->
    <div class="text-center py-5 d-none" id="requireLoginMsg">
        <div class="mb-3">
            <i class="fas fa-lock fa-3x text-muted"></i>
        </div>
        <h5 class="fw-bold text-muted">로그인이 필요합니다</h5>
        <p class="text-muted" style="font-size: 0.9rem;">문의 게시판을 이용하려면 로그인해주세요.</p>
        <button class="btn btn-dark btn-sm rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#authModal">
            <i class="fas fa-sign-in-alt me-1"></i> 로그인하기
        </button>
    </div>

    <!-- 문의 작성 폼 (숨김) -->
    <div class="card border-0 shadow-sm rounded-4 mb-4 d-none" id="writeFormCard" style="overflow: hidden;">
        <div class="card-header bg-dark text-white py-3 px-4 border-0">
            <h6 class="mb-0 fw-bold"><i class="fas fa-pen-nib me-2"></i>새 문의 작성</h6>
        </div>
        <div class="card-body p-4">
            <form id="inquiryForm" novalidate>
                <div class="mb-3">
                    <label class="form-label fw-semibold">제목</label>
                    <input type="text" class="form-control rounded-3" id="inquiryTitle" placeholder="문의 제목을 입력하세요"
                        required maxlength="200" style="padding: 12px 16px; border: 1px solid #e0e0e0;">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">내용</label>
                    <textarea class="form-control rounded-3" id="inquiryContent" rows="6"
                        placeholder="문의 내용을 자세히 작성해주세요" required
                        style="padding: 12px 16px; border: 1px solid #e0e0e0; resize: vertical;"></textarea>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-3" onclick="hideWriteForm()">
                        취소
                    </button>
                    <button type="submit" class="btn btn-dark rounded-pill px-4" id="submitInquiryBtn">
                        <span class="btn-text">등록하기</span>
                        <span class="spinner-border spinner-border-sm d-none" id="inquirySpinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 문의 목록 -->
    <div id="inquiryListSection">
        <!-- 상태 요약 -->
        <div class="row g-3 mb-4" id="inquirySummary">
            <div class="col-4">
                <div class="bg-white rounded-4 p-3 text-center shadow-sm" style="border-left: 4px solid #0d6efd;">
                    <div class="fw-bold fs-4 text-primary" id="totalCount">0</div>
                    <div class="text-muted" style="font-size: 0.8rem;">전체</div>
                </div>
            </div>
            <div class="col-4">
                <div class="bg-white rounded-4 p-3 text-center shadow-sm" style="border-left: 4px solid #ffc107;">
                    <div class="fw-bold fs-4 text-warning" id="pendingCount">0</div>
                    <div class="text-muted" style="font-size: 0.8rem;">대기중</div>
                </div>
            </div>
            <div class="col-4">
                <div class="bg-white rounded-4 p-3 text-center shadow-sm" style="border-left: 4px solid #198754;">
                    <div class="fw-bold fs-4 text-success" id="answeredCount">0</div>
                    <div class="text-muted" style="font-size: 0.8rem;">답변완료</div>
                </div>
            </div>
        </div>

        <!-- 문의 리스트 -->
        <div id="inquiryList"></div>

        <!-- 빈 상태 -->
        <div class="text-center py-5 d-none" id="emptyState">
            <div class="mb-3">
                <i class="far fa-comment-dots fa-3x text-muted" style="opacity: 0.4;"></i>
            </div>
            <h6 class="text-muted fw-bold">아직 문의글이 없습니다</h6>
            <p class="text-muted" style="font-size: 0.85rem;">궁금한 점이 있다면 문의를 작성해보세요!</p>
        </div>

        <!-- 페이지네이션 -->
        <nav id="paginationNav" class="mt-4 d-none">
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>

    <!-- 문의 상세 보기 (숨김) -->
    <div class="d-none" id="inquiryDetailSection">
        <button class="btn btn-sm btn-outline-secondary rounded-pill mb-3 px-3" onclick="backToList()">
            <i class="fas fa-arrow-left me-1"></i> 목록으로
        </button>

        <div class="card border-0 shadow-sm rounded-4" style="overflow: hidden;" id="inquiryDetailCard">
            <!-- 동적으로 채워짐 -->
        </div>
    </div>
</div>

<!-- 수정 모달 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0 pb-0 px-4 pt-4">
                <h5 class="modal-title fw-bold">문의 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editForm" novalidate>
                    <input type="hidden" id="editInquiryId">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">제목</label>
                        <input type="text" class="form-control rounded-3" id="editTitle"
                            style="padding: 12px 16px; border: 1px solid #e0e0e0;" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">내용</label>
                        <textarea class="form-control rounded-3" id="editContent" rows="5"
                            style="padding: 12px 16px; border: 1px solid #e0e0e0; resize: vertical;"
                            required></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-3"
                            data-bs-dismiss="modal">취소</button>
                        <button type="submit" class="btn btn-dark rounded-pill px-4">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .inquiry-page {
        max-width: 700px;
        margin: 0 auto;
    }

    .inquiry-item {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .inquiry-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: #e0e0e0;
    }

    .inquiry-item:active {
        transform: translateY(0);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-pending {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        color: #856404;
    }

    .status-answered {
        background: linear-gradient(135deg, #d1e7dd, #a3d9a5);
        color: #0f5132;
    }

    .detail-header {
        background: linear-gradient(135deg, #212529, #343a40);
        color: #fff;
        padding: 24px;
    }

    .detail-body {
        padding: 24px;
    }

    .detail-content {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        line-height: 1.7;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .answer-section {
        background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
        border-radius: 12px;
        padding: 20px;
        margin-top: 16px;
        border-left: 4px solid #198754;
    }

    .answer-section .answer-content {
        line-height: 1.7;
        white-space: pre-wrap;
        word-break: break-word;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(12px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .inquiry-item {
        animation: fadeInUp 0.3s ease forwards;
    }

    .inquiry-item:nth-child(2) {
        animation-delay: 0.05s;
    }

    .inquiry-item:nth-child(3) {
        animation-delay: 0.1s;
    }

    .inquiry-item:nth-child(4) {
        animation-delay: 0.15s;
    }

    .inquiry-item:nth-child(5) {
        animation-delay: 0.2s;
    }
</style>

<script>
    let inquiryCurrentPage = 1;

    document.addEventListener('DOMContentLoaded', function () {
        // script.js의 checkLoginStatus 완료 후 실행하기 위해 약간의 딜레이
        setTimeout(() => {
            initInquiryPage();
        }, 500);
    });

    async function initInquiryPage() {
        try {
            const resp = await fetch('/api/auth/me', { credentials: 'same-origin' });
            const data = await resp.json();

            if (data.success && data.user) {
                document.getElementById('requireLoginMsg').classList.add('d-none');
                document.getElementById('inquiryListSection').classList.remove('d-none');
                document.getElementById('writeInquiryBtn').classList.remove('d-none');
                loadInquiries();
            } else {
                document.getElementById('requireLoginMsg').classList.remove('d-none');
                document.getElementById('inquiryListSection').classList.add('d-none');
                document.getElementById('writeInquiryBtn').classList.add('d-none');
            }
        } catch (e) {
            document.getElementById('requireLoginMsg').classList.remove('d-none');
            document.getElementById('inquiryListSection').classList.add('d-none');
            document.getElementById('writeInquiryBtn').classList.add('d-none');
        }
    }

    // 문의 목록 로드
    async function loadInquiries(page = 1) {
        inquiryCurrentPage = page;
        try {
            const resp = await fetch(`/api/inquiries?page=${page}&page_size=10`, { credentials: 'same-origin' });
            if (resp.status === 401) {
                document.getElementById('requireLoginMsg').classList.remove('d-none');
                document.getElementById('inquiryListSection').classList.add('d-none');
                return;
            }
            const data = await resp.json();

            const listEl = document.getElementById('inquiryList');
            const emptyEl = document.getElementById('emptyState');

            // 카운트 업데이트
            const total = data.total || 0;
            document.getElementById('totalCount').textContent = total;

            // comment_count 기반 상태 계산
            let allPending = 0, allAnswered = 0;
            if (data.items) {
                data.items.forEach(i => {
                    if ((i.comment_count || 0) > 0) allAnswered++;
                    else allPending++;
                });
            }
            document.getElementById('pendingCount').textContent = allPending;
            document.getElementById('answeredCount').textContent = allAnswered;

            if (!data.items || data.items.length === 0) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('d-none');
                document.getElementById('paginationNav').classList.add('d-none');
                return;
            }

            emptyEl.classList.add('d-none');
            listEl.innerHTML = data.items.map(item => {
                const hasAnswer = (item.comment_count || 0) > 0;
                return `
            <div class="inquiry-item" onclick="viewInquiry(${item.inquiry_board_id})">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="fw-bold mb-0" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${escapeHtml(item.title)}
                    </h6>
                    <span class="status-badge ${hasAnswer ? 'status-answered' : 'status-pending'} ms-2">
                        ${hasAnswer
                        ? '<i class="fas fa-check-circle"></i> 답변완료'
                        : '<i class="fas fa-clock"></i> 대기중'}
                    </span>
                </div>
                <p class="text-muted mb-2" style="font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${escapeHtml(item.content || '')}
                </p>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="far fa-clock me-1"></i>${formatDate(item.create_dt)}
                    </small>
                    <small class="text-muted">
                        <i class="far fa-eye me-1"></i>${item.view_count || 0}
                    </small>
                </div>
            </div>
            `;
            }).join('');

            // 페이지네이션
            renderPagination(data.total_pages, page);

        } catch (e) {
            console.error('문의 목록 로드 실패:', e);
        }
    }

    // 문의 상세 보기
    async function viewInquiry(postId) {
        try {
            const resp = await fetch(`/api/inquiries/${postId}`, { credentials: 'same-origin' });
            if (!resp.ok) {
                if (typeof showToast === 'function') showToast('문의글을 불러올 수 없습니다.', 'error');
                return;
            }
            const data = await resp.json();
            const item = data.post;
            const comments = data.comments || [];
            const hasAnswer = comments.length > 0;

            document.getElementById('inquiryListSection').classList.add('d-none');
            document.getElementById('inquiryDetailSection').classList.remove('d-none');
            document.getElementById('writeInquiryBtn').classList.add('d-none');

            const card = document.getElementById('inquiryDetailCard');
            card.innerHTML = `
            <div class="detail-header">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="status-badge ${hasAnswer ? 'status-answered' : 'status-pending'}">
                        ${hasAnswer
                    ? '<i class="fas fa-check-circle"></i> 답변완료'
                    : '<i class="fas fa-clock"></i> 대기중'}
                    </span>
                    ${!hasAnswer ? `
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-light rounded-pill" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                            <li><a class="dropdown-item" href="#" onclick="openEditModal(${item.inquiry_board_id}, '${escapeHtml(item.title).replace(/'/g, "\\'")}', \`${escapeHtml(item.content || '').replace(/`/g, "\\`")}\`); return false;">
                                <i class="fas fa-edit me-2"></i>수정
                            </a></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteInquiry(${item.inquiry_board_id}); return false;">
                                <i class="fas fa-trash me-2"></i>삭제
                            </a></li>
                        </ul>
                    </div>
                    ` : ''}
                </div>
                <h5 class="fw-bold mb-2">${escapeHtml(item.title)}</h5>
                <div class="d-flex gap-3" style="font-size: 0.8rem; opacity: 0.8;">
                    <span><i class="far fa-clock me-1"></i>${formatDate(item.create_dt)}</span>
                    <span><i class="far fa-eye me-1"></i>${item.view_count || 0}</span>
                </div>
            </div>
            <div class="detail-body">
                <div class="detail-content">${escapeHtml(item.content || '')}</div>
                ${hasAnswer ? comments.map(c => `
                <div class="answer-section">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-2"
                            style="width: 32px; height: 32px;">
                            <i class="fas fa-headset text-white" style="font-size: 0.8rem;"></i>
                        </div>
                        <div>
                            <div class="fw-bold" style="font-size: 0.9rem;">관리자 답변</div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                ${escapeHtml(c.author_name || '관리자')} · ${formatDate(c.create_dt)}
                            </div>
                        </div>
                    </div>
                    <div class="answer-content">${escapeHtml(c.comment_text || '')}</div>
                </div>
                `).join('') : `
                <div class="text-center py-4 mt-3" style="opacity: 0.5;">
                    <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                    <p class="mb-0" style="font-size: 0.85rem;">관리자 답변을 기다리고 있습니다...</p>
                </div>
                `}
            </div>
        `;

        } catch (e) {
            console.error('문의 상세 조회 실패:', e);
        }
    }

    function backToList() {
        document.getElementById('inquiryDetailSection').classList.add('d-none');
        document.getElementById('inquiryListSection').classList.remove('d-none');
        document.getElementById('writeInquiryBtn').classList.remove('d-none');
        loadInquiries(inquiryCurrentPage);
    }

    // 문의 작성
    function showWriteForm() {
        document.getElementById('writeFormCard').classList.remove('d-none');
        document.getElementById('writeInquiryBtn').classList.add('d-none');
        document.getElementById('inquiryTitle').focus();
    }

    function hideWriteForm() {
        document.getElementById('writeFormCard').classList.add('d-none');
        document.getElementById('writeInquiryBtn').classList.remove('d-none');
        document.getElementById('inquiryForm').reset();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('inquiryForm');
        if (form) {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const title = document.getElementById('inquiryTitle').value.trim();
                const content = document.getElementById('inquiryContent').value.trim();

                if (!title) {
                    if (typeof showToast === 'function') showToast('제목을 입력해주세요.', 'error');
                    return;
                }
                if (!content) {
                    if (typeof showToast === 'function') showToast('내용을 입력해주세요.', 'error');
                    return;
                }

                const btn = document.getElementById('submitInquiryBtn');
                const spinner = document.getElementById('inquirySpinner');
                const btnText = btn.querySelector('.btn-text');

                btn.disabled = true;
                spinner.classList.remove('d-none');
                btnText.classList.add('d-none');

                try {
                    const resp = await fetch('/api/inquiries', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ title, content }),
                    });

                    if (resp.ok) {
                        if (typeof showToast === 'function') showToast('문의가 등록되었습니다!', 'success');
                        hideWriteForm();
                        loadInquiries(1);
                    } else {
                        const err = await resp.json();
                        if (typeof showToast === 'function') showToast(err.detail || '등록에 실패했습니다.', 'error');
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('서버 연결에 실패했습니다.', 'error');
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('d-none');
                    btnText.classList.remove('d-none');
                }
            });
        }
    });

    // 수정
    function openEditModal(id, title, content) {
        document.getElementById('editInquiryId').value = id;
        document.getElementById('editTitle').value = title;
        document.getElementById('editContent').value = content;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const editForm = document.getElementById('editForm');
        if (editForm) {
            editForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = document.getElementById('editInquiryId').value;
                const title = document.getElementById('editTitle').value.trim();
                const content = document.getElementById('editContent').value.trim();

                if (!title || !content) {
                    if (typeof showToast === 'function') showToast('제목과 내용을 모두 입력해주세요.', 'error');
                    return;
                }

                try {
                    const resp = await fetch(`/api/inquiries/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ title, content }),
                    });

                    if (resp.ok) {
                        if (typeof showToast === 'function') showToast('문의가 수정되었습니다.', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        viewInquiry(id);
                    } else {
                        const err = await resp.json();
                        if (typeof showToast === 'function') showToast(err.detail || '수정에 실패했습니다.', 'error');
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('서버 연결에 실패했습니다.', 'error');
                }
            });
        }
    });

    // 삭제
    async function deleteInquiry(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        try {
            const resp = await fetch(`/api/inquiries/${id}`, {
                method: 'DELETE',
                credentials: 'same-origin',
            });

            if (resp.ok || resp.status === 204) {
                if (typeof showToast === 'function') showToast('문의가 삭제되었습니다.', 'success');
                backToList();
            } else {
                const err = await resp.json();
                if (typeof showToast === 'function') showToast(err.detail || '삭제에 실패했습니다.', 'error');
            }
        } catch (e) {
            if (typeof showToast === 'function') showToast('서버 연결에 실패했습니다.', 'error');
        }
    }

    // 페이지네이션
    function renderPagination(totalPages, currentPage) {
        const navEl = document.getElementById('paginationNav');
        const pagEl = document.getElementById('pagination');

        if (totalPages <= 1) {
            navEl.classList.add('d-none');
            return;
        }

        navEl.classList.remove('d-none');
        let html = '';

        html += `<li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadInquiries(${currentPage - 1}); return false;">‹</a>
    </li>`;

        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadInquiries(${i}); return false;">${i}</a>
        </li>`;
        }

        html += `<li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadInquiries(${currentPage + 1}); return false;">›</a>
    </li>`;

        pagEl.innerHTML = html;
    }

    // 유틸
    function escapeHtml(str) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return str.replace(/[&<>"']/g, c => map[c]);
    }

    function formatDate(dtStr) {
        if (!dtStr) return '';
        const d = new Date(dtStr);
        const now = new Date();
        const diff = now - d;

        if (diff < 60000) return '방금 전';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}분 전`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}시간 전`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}일 전`;

        return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
    }
</script>
{% endblock %}