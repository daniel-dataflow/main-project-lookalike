<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Lookalike Admin{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        /* [수정] 사이드바 스타일 반응형 처리 */
        .sidebar {
            width: 250px;
            background-color: #fff;
            border-right: 1px solid #dee2e6;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            z-index: 1000;
        }

        /* [수정] 메인 콘텐츠 여백 반응형 처리 */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        /* 모바일용 스타일 */
        @media (max-width: 768px) {
            .sidebar {
                display: none !important;
                /* 기본 사이드바 숨김 */
            }

            .main-content {
                margin-left: 0 !important;
                /* 여백 제거 */
                padding: 15px;
                /* 패딩 축소 */
            }
        }

        .sidebar .nav-pills .nav-link {
            color: #333;
            border-radius: 8px;
            margin-bottom: 2px;
            padding: 10px 16px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        /* ... (기존 스타일 유지) ... */
    </style>
</head>

<body class="bg-light">

    <!-- 어드민 인증 오버레이 (생략 없이 유지) -->

    <!-- ... (인증 오버레이 코드) ... -->

    <!-- [수정] 데스크탑용 사이드바 (md 이상에서만 표시) -->
    <div class="sidebar d-none d-md-flex flex-column p-3" id="adminSidebar">
        <a href="/admin" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
            <i class="fas fa-user-shield text-primary fs-4 me-2"></i>
            <span class="fs-4 fw-bold">관리자 페이지</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="/admin" class="nav-link link-dark {% if request.url.path == '/admin' %}active{% endif %}">
                    <i class="fas fa-chart-line me-2"></i>
                    실시간 모니터링
                </a>
            </li>
            <li>
                <a href="/admin/infra"
                    class="nav-link link-dark {% if request.url.path == '/admin/infra' %}active{% endif %}">
                    <i class="fas fa-server me-2"></i>
                    인프라 모니터링
                </a>
            </li>
            <li>
                <a href="/admin/batch"
                    class="nav-link link-dark {% if request.url.path == '/admin/batch' %}active{% endif %}">
                    <i class="fas fa-cogs me-2"></i>
                    배치작업 모니터링
                </a>
            </li>
            <li>
                <a href="/admin/inquiry"
                    class="nav-link link-dark {% if request.url.path == '/admin/inquiry' %}active{% endif %}">
                    <i class="far fa-comment-dots me-2"></i>
                    문의 관리
                </a>
            </li>
        </ul>
        <hr>
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center link-dark text-decoration-none dropdown-toggle"
                id="dropdownUser2" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="" width="32" height="32"
                    class="rounded-circle me-2">
                <strong id="adminUserName">Admin</strong>
            </a>
            <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
                <li><a class="dropdown-item" href="/">사용자 홈으로</a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" onclick="adminLogout(); return false;">
                        <i class="fas fa-sign-out-alt me-1"></i>관리자 로그아웃
                    </a></li>
            </ul>
        </div>
    </div>

    <!-- [추가] 모바일용 Offcanvas 사이드바 -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold" id="mobileSidebarLabel">
                <i class="fas fa-user-shield text-primary me-2"></i>관리자 메뉴
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="/admin" class="nav-link link-dark {% if request.url.path == '/admin' %}active{% endif %}">
                        <i class="fas fa-chart-line me-2"></i> 실시간 모니터링
                    </a>
                </li>
                <li>
                    <a href="/admin/infra"
                        class="nav-link link-dark {% if request.url.path == '/admin/infra' %}active{% endif %}">
                        <i class="fas fa-server me-2"></i> 인프라 모니터링
                    </a>
                </li>
                <li>
                    <a href="/admin/batch"
                        class="nav-link link-dark {% if request.url.path == '/admin/batch' %}active{% endif %}">
                        <i class="fas fa-cogs me-2"></i> 배치작업 모니터링
                    </a>
                </li>
                <li>
                    <a href="/admin/inquiry"
                        class="nav-link link-dark {% if request.url.path == '/admin/inquiry' %}active{% endif %}">
                        <i class="far fa-comment-dots me-2"></i> 문의 관리
                    </a>
                </li>
            </ul>
            <hr>
            <div class="d-grid gap-2">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-1"></i> 사용자 홈으로
                </a>
                <button class="btn btn-outline-danger" onclick="adminLogout()">
                    <i class="fas fa-sign-out-alt me-1"></i> 로그아웃
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="adminMainContent"> <!-- 초기 display 스타일 제거 -->
        <!-- Top Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div class="d-flex align-items-center">
                <!-- [추가] 모바일 햄버거 메뉴 버튼 -->
                <button class="btn btn-link text-dark p-0 me-3 d-md-none" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#mobileSidebar">
                    <i class="fas fa-bars fs-4"></i>
                </button>
                <h5 class="m-0 fw-bold">{% block page_title %}Dashboard{% endblock %}</h5>
            </div>

            <div class="d-flex align-items-center">
                <div class="d-none d-md-block input-group me-3" style="max-width: 250px;">
                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" class="form-control bg-light border-start-0" placeholder="Search...">
                </div>
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold" id="adminTopName">Admin</div>
                    <small class="text-success" style="font-size: 0.7rem;">FULL ACCESS</small>
                </div>
                <!-- 모바일용 간단 프로필 아이콘 -->
                <div class="d-md-none">
                    <i class="fas fa-user-circle fs-4 text-secondary"></i>
                </div>
            </div>
        </div>

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>

    <script>
        // 페이지 로드 시 어드민 인증 상태 확인
        document.addEventListener('DOMContentLoaded', function () {
            checkAdminAuth();
        });

        async function checkAdminAuth() {
            try {
                const resp = await fetch('/api/auth/admin/check', { credentials: 'same-origin' });
                const data = await resp.json();

                if (data.is_admin) {
                    showAdminContent();
                    // 사용자 이름 표시
                    const meResp = await fetch('/api/auth/me', { credentials: 'same-origin' });
                    const meData = await meResp.json();
                    if (meData.success && meData.user) {
                        const name = meData.user.name || 'Admin';
                        document.getElementById('adminUserName').textContent = name;
                        document.getElementById('adminTopName').textContent = name;
                    }
                } else {
                    showAdminAuth();
                }
            } catch (e) {
                showAdminAuth();
            }
        }

        function showAdminAuth() {
            document.getElementById('adminAuthOverlay').style.display = 'flex';
            // 인증 전에는 사이드바/메인 숨김 (클래스로 제어하거나 display: none 유지)
            document.getElementById('adminMainContent').classList.add('d-none');
            // 사이드바는 d-none d-md-flex 클래스가 있으므로 추가 제어 불필요하지만, 확실히 숨기려면:
            // document.getElementById('adminSidebar').classList.add('d-none'); 

            document.getElementById('adminPassword').focus();
        }

        function showAdminContent() {
            document.getElementById('adminAuthOverlay').style.display = 'none';

            // 인증 완료 시 메인 콘텐츠 확실하게 보이기
            const mainContent = document.getElementById('adminMainContent');
            if (mainContent) {
                mainContent.classList.remove('d-none');
                // 인라인 스타일 제거 (혹시 남아있을 경우)
                mainContent.style.removeProperty('display');
            }

            // 사이드바 확실하게 보이기 (모바일/데스크탑 반응형 고려)
            const sidebar = document.getElementById('adminSidebar');
            if (sidebar) {
                sidebar.style.removeProperty('display');
                sidebar.style.display = '';
            }
        }

        async function adminLogin(e) {
            e.preventDefault();

            const password = document.getElementById('adminPassword').value.trim();
            if (!password) return;

            const btn = document.getElementById('adminLoginBtn');
            const spinner = document.getElementById('adminLoginSpinner');
            const btnText = btn.querySelector('.btn-text');
            const errorEl = document.getElementById('adminAuthError');

            btn.disabled = true;
            spinner.classList.remove('d-none');
            btnText.classList.add('d-none');
            errorEl.style.display = 'none';

            try {
                const resp = await fetch('/api/auth/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ password }),
                });

                if (resp.ok) {
                    showAdminContent();
                    // 페이지 새로고침하여 콘텐츠 제대로 로드
                    location.reload();
                } else {
                    const err = await resp.json();
                    document.getElementById('adminAuthErrorMsg').textContent =
                        err.detail || '인증에 실패했습니다.';
                    errorEl.style.display = 'block';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();
                }
            } catch (e) {
                document.getElementById('adminAuthErrorMsg').textContent = '서버 연결에 실패했습니다.';
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
                btnText.classList.remove('d-none');
            }
        }

        async function adminLogout() {
            try {
                await fetch('/api/auth/admin/logout', {
                    method: 'POST',
                    credentials: 'same-origin',
                });
            } catch (e) { }
            location.href = '/';
        }
    </script>
</body>

</html>