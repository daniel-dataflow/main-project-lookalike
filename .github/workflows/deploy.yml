name: EC2 직접 배포 (Anaconda)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: 배포 수행
    runs-on: ubuntu-latest

    steps:
    - name: EC2 접속 및 배포
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          # ----------------------------------------------------------------
          # [설정 1] Python 실행 경로 (1단계 'which python' 결과값)
          # (Miniconda는 miniconda3, Anaconda는 anaconda3 일 수 있음)
          # ----------------------------------------------------------------
          CONDA_PYTHON="/home/ubuntu/miniconda3/envs/ml-env/bin/python"
          CONDA_PIP="/home/ubuntu/miniconda3/envs/ml-env/bin/pip"

          # ----------------------------------------------------------------
          # [설정 2] 프로젝트 폴더명 수정
          # ----------------------------------------------------------------
          cd /home/${{ secrets.EC2_USER }}/main-project-lookalike

          # 1. 최신 코드 가져오기
          git fetch origin main
          git reset --hard origin/main

          # 2. 라이브러리 설치 (Conda 환경의 pip 사용)
          # (pip는 이미 설치된 라이브러리는 자동으로 건너뛰므로 매번 실행해도 안전하고 빠릅니다)
          $CONDA_PIP install -r web/backend/requirements.txt

          # 3. 기존 서버 종료 (8900번 포트)
          sudo fuser -k 8900/tcp || true

          # 4. 서버 재시작 (Conda 환경의 python 사용)
          nohup $CONDA_PYTHON -m uvicorn web.backend.main:app --host 0.0.0.0 --port 8900 > nohup.out 2>&1 &